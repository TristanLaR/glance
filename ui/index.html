<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Glance</title>
    <link rel="stylesheet" href="github-markdown.min.css">
    <link rel="stylesheet" href="hljs-github.min.css">
    <link rel="stylesheet" href="hljs-github-dark.min.css" media="(prefers-color-scheme: dark)">
    <script src="marked.min.js"></script>
    <script src="purify.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <!-- highlight.min.js is lazy-loaded only when code blocks are detected -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans', Helvetica, Arial, sans-serif;
        }

        body {
            background-color: #ffffff;
        }

        .markdown-body {
            padding: 32px;
            max-width: 980px;
            margin: 0 auto;
            min-height: 100%;
        }

        .error {
            color: #cf222e;
            padding: 20px;
            text-align: center;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            color: #656d76;
        }

        .welcome {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 60vh;
            text-align: center;
            color: #656d76;
        }

        .welcome h1 {
            font-size: 2.5em;
            font-weight: 600;
            margin-bottom: 0.5em;
            color: #24292f;
        }

        .welcome p {
            font-size: 1.1em;
            margin-bottom: 2em;
        }

        .welcome .instructions {
            text-align: left;
            background: #f6f8fa;
            padding: 1.5em 2em;
            border-radius: 8px;
            border: 1px solid #d0d7de;
        }

        .welcome .instructions p {
            margin-bottom: 0.5em;
            font-weight: 500;
            color: #24292f;
        }

        .welcome .instructions ul {
            margin: 0;
            padding-left: 1.5em;
        }

        .welcome .instructions li {
            margin: 0.5em 0;
        }

        .welcome kbd {
            background: #eee;
            border: 1px solid #ccc;
            border-radius: 3px;
            padding: 2px 6px;
            font-family: ui-monospace, SFMono-Regular, SF Mono, Menlo, Consolas, monospace;
            font-size: 0.9em;
        }

        @media (prefers-color-scheme: dark) {
            .welcome {
                color: #8b949e;
            }

            .welcome h1 {
                color: #e6edf3;
            }

            .welcome .instructions {
                background: #161b22;
                border-color: #30363d;
            }

            .welcome .instructions p {
                color: #e6edf3;
            }

            .welcome kbd {
                background: #21262d;
                border-color: #30363d;
                color: #e6edf3;
            }
        }

        /* Code block container for copy button */
        .code-block-wrapper {
            position: relative;
        }

        .code-block-wrapper .copy-button {
            position: absolute;
            top: 8px;
            right: 8px;
            padding: 4px 8px;
            font-size: 12px;
            color: #57606a;
            background-color: #f6f8fa;
            border: 1px solid #d0d7de;
            border-radius: 6px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.15s ease-in-out;
        }

        .code-block-wrapper:hover .copy-button {
            opacity: 1;
        }

        .code-block-wrapper .copy-button:hover {
            background-color: #f3f4f6;
            border-color: #c5cbd1;
        }

        .code-block-wrapper .copy-button:active {
            background-color: #ebecef;
        }

        .code-block-wrapper .copy-button.copied {
            color: #1a7f37;
            border-color: #1a7f37;
        }

        /* Image error placeholder */
        .image-placeholder {
            background-color: #f6f8fa;
            border: 2px dashed #d0d7de;
            border-radius: 8px;
            padding: 16px;
            text-align: center;
            margin: 16px 0;
            display: inline-block;
            min-width: 200px;
        }

        .image-error {
            color: #57606a;
        }

        .image-error-icon {
            font-size: 32px;
            margin-bottom: 8px;
        }

        .image-error-text {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .image-error-alt {
            font-size: 12px;
            font-family: monospace;
            margin-top: 4px;
            word-break: break-word;
        }

        .image-error-src {
            font-size: 11px;
            font-family: monospace;
            color: #8b949e;
            margin-top: 4px;
            word-break: break-all;
            max-width: 300px;
        }

        /* Dark mode support */
        @media (prefers-color-scheme: dark) {
            body {
                background-color: #0d1117;
            }

            .markdown-body {
                color-scheme: dark;
                --color-canvas-default: #0d1117;
                --color-canvas-subtle: #161b22;
                --color-border-default: #30363d;
                --color-border-muted: #21262d;
            }

            .code-block-wrapper .copy-button {
                color: #8b949e;
                background-color: #21262d;
                border-color: #30363d;
            }

            .code-block-wrapper:hover .copy-button {
                background-color: #30363d;
            }

            .code-block-wrapper .copy-button:hover {
                background-color: #30363d;
                border-color: #484f58;
            }

            .code-block-wrapper .copy-button.copied {
                color: #3fb950;
                border-color: #3fb950;
            }

            .image-placeholder {
                background-color: #161b22;
                border-color: #30363d;
            }

            .image-error {
                color: #8b949e;
            }

            .image-error-src {
                color: #6e7681;
            }
        }

        /* Zoom indicator */
        #zoom-indicator {
            position: fixed;
            bottom: 16px;
            right: 16px;
            padding: 6px 12px;
            font-size: 12px;
            font-weight: 500;
            color: #57606a;
            background-color: rgba(246, 248, 250, 0.95);
            border: 1px solid #d0d7de;
            border-radius: 6px;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            pointer-events: none;
            z-index: 1000;
        }

        #zoom-indicator.visible {
            opacity: 0.6;
        }

        #zoom-indicator.active {
            opacity: 1;
        }

        @media (prefers-color-scheme: dark) {
            #zoom-indicator {
                color: #8b949e;
                background-color: rgba(33, 38, 45, 0.95);
                border-color: #30363d;
            }
        }

        /* Large file mode - TOC and accordion styles */
        .large-file-toc {
            background-color: #f6f8fa;
            border: 1px solid #d0d7de;
            border-radius: 6px;
            padding: 16px;
            margin-bottom: 24px;
        }

        .large-file-toc h2 {
            margin: 0 0 12px 0;
            font-size: 14px;
            font-weight: 600;
            color: #24292f;
        }

        .large-file-toc ul {
            list-style: none;
            margin: 0;
            padding: 0;
        }

        .large-file-toc li {
            margin: 4px 0;
        }

        .large-file-toc a {
            color: #0969da;
            text-decoration: none;
            font-size: 14px;
        }

        .large-file-toc a:hover {
            text-decoration: underline;
        }

        .large-file-toc .toc-level-1 { padding-left: 0; }
        .large-file-toc .toc-level-2 { padding-left: 16px; }
        .large-file-toc .toc-level-3 { padding-left: 32px; }
        .large-file-toc .toc-level-4 { padding-left: 48px; }
        .large-file-toc .toc-level-5 { padding-left: 64px; }
        .large-file-toc .toc-level-6 { padding-left: 80px; }

        /* Accordion section styles */
        .section-accordion {
            border: 1px solid #d0d7de;
            border-radius: 6px;
            margin-bottom: 8px;
            overflow: hidden;
        }

        .section-accordion summary {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            cursor: pointer;
            background-color: #f6f8fa;
            border: none;
            font-size: 14px;
            font-weight: 600;
            color: #24292f;
            list-style: none;
            user-select: none;
        }

        .section-accordion summary::-webkit-details-marker {
            display: none;
        }

        .section-accordion summary::before {
            content: '';
            display: inline-block;
            width: 0;
            height: 0;
            border-left: 5px solid #57606a;
            border-top: 4px solid transparent;
            border-bottom: 4px solid transparent;
            margin-right: 10px;
            transition: transform 0.15s ease;
        }

        .section-accordion[open] summary::before {
            transform: rotate(90deg);
        }

        .section-accordion summary:hover {
            background-color: #eaeef2;
        }

        .section-accordion .section-content {
            padding: 16px;
            border-top: 1px solid #d0d7de;
        }

        .section-accordion .section-level {
            display: inline-block;
            min-width: 24px;
            height: 18px;
            line-height: 18px;
            text-align: center;
            font-size: 11px;
            font-weight: 600;
            background-color: #ddf4ff;
            color: #0969da;
            border-radius: 10px;
            margin-right: 8px;
        }

        .section-accordion .section-level-0 {
            background-color: #fff8c5;
            color: #9a6700;
        }

        /* Large file mode banner */
        .large-file-banner {
            background-color: #fff8c5;
            border: 1px solid #d4a72c;
            border-radius: 6px;
            padding: 12px 16px;
            margin-bottom: 16px;
            font-size: 13px;
            color: #735c0f;
        }

        .large-file-banner code {
            background-color: rgba(0, 0, 0, 0.08);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
        }

        @media (prefers-color-scheme: dark) {
            .large-file-toc {
                background-color: #161b22;
                border-color: #30363d;
            }

            .large-file-toc h2 {
                color: #c9d1d9;
            }

            .large-file-toc a {
                color: #58a6ff;
            }

            .section-accordion {
                border-color: #30363d;
            }

            .section-accordion summary {
                background-color: #161b22;
                color: #c9d1d9;
            }

            .section-accordion summary::before {
                border-left-color: #8b949e;
            }

            .section-accordion summary:hover {
                background-color: #21262d;
            }

            .section-accordion .section-content {
                border-top-color: #30363d;
            }

            .section-accordion .section-level {
                background-color: #388bfd26;
                color: #58a6ff;
            }

            .section-accordion .section-level-0 {
                background-color: #bb800926;
                color: #e3b341;
            }

            .large-file-banner {
                background-color: #bb800926;
                border-color: #bb8009;
                color: #e3b341;
            }

            .large-file-banner code {
                background-color: rgba(255, 255, 255, 0.1);
            }
        }

        /* PlantUML diagram styles */
        .plantuml-diagram {
            margin: 16px 0;
            text-align: center;
        }

        .plantuml-diagram svg {
            max-width: 100%;
            height: auto;
            background-color: #ffffff;
            border-radius: 8px;
            padding: 16px;
        }

        /* Mermaid diagram styles */
        .mermaid {
            margin: 16px 0;
            text-align: center;
            background-color: transparent;
            border-radius: 8px;
            padding: 16px;
            display: flex;
            justify-content: center;
        }

        .mermaid svg {
            max-width: 100%;
            height: auto;
        }

        .plantuml-loading,
        .mermaid-loading {
            padding: 24px;
            color: #656d76;
            background-color: #f6f8fa;
            border: 1px dashed #d0d7de;
            border-radius: 6px;
        }

        .plantuml-error,
        .mermaid-error {
            padding: 24px;
            color: #cf222e;
            background-color: #ffebe9;
            border: 1px solid #ff8182;
            border-radius: 6px;
        }

        @media (prefers-color-scheme: dark) {
            .mermaid {
                background-color: #0d1117;
                border: 1px solid #30363d;
            }

            .plantuml-loading,
            .mermaid-loading {
                color: #8b949e;
                background-color: #161b22;
                border-color: #30363d;
            }

            .plantuml-error,
            .mermaid-error {
                color: #ff7b72;
                background-color: #490202;
                border-color: #f85149;
            }
        }
    </style>
</head>
<body>
    <article id="content" class="markdown-body">
        <div class="loading">Loading...</div>
    </article>

    <script>
        // Zoom state - persisted in sessionStorage
        const ZOOM_MIN = 50;
        const ZOOM_MAX = 200;
        const ZOOM_STEP = 10;
        const ZOOM_DEFAULT = 100;

        let currentZoom = parseInt(sessionStorage.getItem('zoomLevel')) || ZOOM_DEFAULT;

        function applyZoom() {
            const contentEl = document.getElementById('content');
            contentEl.style.transformOrigin = 'top center';
            contentEl.style.transform = `scale(${currentZoom / 100})`;

            // Adjust body height to accommodate scaled content
            document.body.style.minHeight = `${100 * (currentZoom / 100)}%`;

            // Persist zoom level
            sessionStorage.setItem('zoomLevel', currentZoom);

            // Update zoom indicator
            updateZoomIndicator();
        }

        function zoomIn() {
            if (currentZoom < ZOOM_MAX) {
                currentZoom = Math.min(currentZoom + ZOOM_STEP, ZOOM_MAX);
                applyZoom();
            }
        }

        function zoomOut() {
            if (currentZoom > ZOOM_MIN) {
                currentZoom = Math.max(currentZoom - ZOOM_STEP, ZOOM_MIN);
                applyZoom();
            }
        }

        function resetZoom() {
            currentZoom = ZOOM_DEFAULT;
            applyZoom();
        }

        function updateZoomIndicator() {
            let indicator = document.getElementById('zoom-indicator');
            if (!indicator) {
                indicator = document.createElement('div');
                indicator.id = 'zoom-indicator';
                document.body.appendChild(indicator);
            }

            // Only show indicator when zoom is not at default
            if (currentZoom !== ZOOM_DEFAULT) {
                indicator.textContent = `${currentZoom}%`;
                indicator.classList.add('visible');
            } else {
                indicator.classList.remove('visible');
            }

            // Briefly show indicator on any zoom change, then fade
            indicator.classList.add('active');
            clearTimeout(indicator.fadeTimeout);
            indicator.fadeTimeout = setTimeout(() => {
                indicator.classList.remove('active');
            }, 1500);
        }

        // Helper to escape HTML for error messages
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Truncate URL for display
        function truncateUrl(url, maxLength) {
            if (url.length <= maxLength) return url;
            return url.substring(0, maxLength - 3) + '...';
        }

        // Handle image load errors - show placeholder with alt text
        function handleImageError(img) {
            const alt = img.alt || 'Image';
            const src = img.getAttribute('data-original-src') || img.src;

            const placeholder = document.createElement('div');
            placeholder.className = 'image-placeholder';
            placeholder.innerHTML = `
                <div class="image-error">
                    <div class="image-error-icon">&#128444;</div>
                    <div class="image-error-text">Image failed to load</div>
                    <div class="image-error-alt">${escapeHtml(alt)}</div>
                    <div class="image-error-src" title="${escapeHtml(src)}">${escapeHtml(truncateUrl(src, 50))}</div>
                </div>
            `;

            img.parentNode.replaceChild(placeholder, img);
        }

        // Resolve relative path against base directory
        function resolveRelativePath(baseDir, relativePath) {
            // Handle absolute paths (starts with /)
            if (relativePath.startsWith('/')) {
                return relativePath;
            }

            const baseParts = baseDir.split('/').filter(p => p !== '');
            const pathParts = relativePath.split('/');

            for (const part of pathParts) {
                if (part === '..') {
                    baseParts.pop();
                } else if (part !== '.' && part !== '') {
                    baseParts.push(part);
                }
            }

            return '/' + baseParts.join('/');
        }

        // Create custom image renderer for marked
        function createImageRenderer(fileDir) {
            return {
                image(token) {
                    let src = token.href;
                    const alt = escapeHtml(token.text || '');
                    const title = token.title ? ` title="${escapeHtml(token.title)}"` : '';

                    // Keep track of original src for error display
                    const originalSrc = src;

                    // Check if it's a data URL (base64) or remote URL
                    const isDataUrl = src.startsWith('data:');
                    const isRemoteUrl = src.startsWith('http://') || src.startsWith('https://');

                    // Resolve local relative paths
                    if (!isDataUrl && !isRemoteUrl && fileDir) {
                        const resolvedPath = resolveRelativePath(fileDir, src);
                        // Use Tauri's convertFileSrc for local files
                        src = window.__TAURI__.tauri.convertFileSrc(resolvedPath);
                    }

                    return `<img src="${src}" alt="${alt}"${title} data-original-src="${escapeHtml(originalSrc)}" onerror="handleImageError(this)" style="max-width:100%;height:auto;">`;
                }
            };
        }

        // Apply syntax highlighting and copy buttons to code blocks
        // Highlight.js lazy-loading state
        let hljsLoaded = false;
        let hljsLoading = null;

        // Lazy-load highlight.js only when needed
        function loadHighlightJs() {
            if (hljsLoaded) return Promise.resolve();
            if (hljsLoading) return hljsLoading;

            hljsLoading = new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = 'highlight.min.js';
                script.onload = () => {
                    hljsLoaded = true;
                    resolve();
                };
                script.onerror = () => reject(new Error('Failed to load highlight.js'));
                document.head.appendChild(script);
            });

            return hljsLoading;
        }

        // PlantUML encoding using deflate + custom base64
        function encodePlantUML(text) {
            // Use pako for reliable deflate compression
            const data = new TextEncoder().encode(text);
            const compressed = pako.deflateRaw(data, { level: 9 });

            // PlantUML's custom base64 encoding
            function encode6bit(b) {
                if (b < 10) return String.fromCharCode(48 + b); // '0'-'9'
                b -= 10;
                if (b < 26) return String.fromCharCode(65 + b); // 'A'-'Z'
                b -= 26;
                if (b < 26) return String.fromCharCode(97 + b); // 'a'-'z'
                b -= 26;
                if (b === 0) return '-';
                if (b === 1) return '_';
                return '?';
            }

            function encode3bytes(b1, b2, b3) {
                const c1 = b1 >> 2;
                const c2 = ((b1 & 0x3) << 4) | (b2 >> 4);
                const c3 = ((b2 & 0xF) << 2) | (b3 >> 6);
                const c4 = b3 & 0x3F;
                return encode6bit(c1) + encode6bit(c2) + encode6bit(c3) + encode6bit(c4);
            }

            let result = '';
            for (let i = 0; i < compressed.length; i += 3) {
                const b1 = compressed[i];
                const b2 = i + 1 < compressed.length ? compressed[i + 1] : 0;
                const b3 = i + 2 < compressed.length ? compressed[i + 2] : 0;
                result += encode3bytes(b1, b2, b3);
            }

            return result;
        }

        // Render a full PlantUML file (.puml, .plantuml)
        async function renderPlantUMLFile(code, contentEl) {
            // Auto-add transparent background
            if (!code.includes('skinparam backgroundColor')) {
                code = code.replace('@startuml', '@startuml\nskinparam backgroundColor transparent');
            }

            contentEl.innerHTML = '<div class="plantuml-diagram"><div class="plantuml-loading">Rendering diagram...</div></div>';

            try {
                const encoded = encodePlantUML(code);
                const response = await fetch(`https://www.plantuml.com/plantuml/svg/${encoded}`);
                if (response.ok) {
                    const svg = await response.text();
                    contentEl.innerHTML = `<div class="plantuml-diagram">${svg}</div>`;
                } else {
                    contentEl.innerHTML = '<div class="plantuml-diagram"><div class="plantuml-error">Failed to render diagram</div></div>';
                }
            } catch (error) {
                console.error('PlantUML render error:', error);
                contentEl.innerHTML = '<div class="plantuml-diagram"><div class="plantuml-error">Failed to render diagram</div></div>';
            }
        }

        // Render PlantUML diagrams (requires extensions.plantuml = true)
        async function renderPlantUMLDiagrams() {
            const codeBlocks = document.querySelectorAll('pre code.language-plantuml, pre code.language-puml');
            if (codeBlocks.length === 0) return;

            for (const block of codeBlocks) {
                let code = block.textContent;

                // Auto-add transparent background for dark/light mode compatibility
                if (!code.includes('skinparam backgroundColor')) {
                    code = code.replace('@startuml', '@startuml\nskinparam backgroundColor transparent');
                }

                const pre = block.parentElement;

                // Create placeholder while loading
                const placeholder = document.createElement('div');
                placeholder.className = 'plantuml-diagram';
                placeholder.innerHTML = '<div class="plantuml-loading">Rendering diagram...</div>';
                pre.parentNode.replaceChild(placeholder, pre);

                try {
                    const encoded = encodePlantUML(code);
                    const response = await fetch(`https://www.plantuml.com/plantuml/svg/${encoded}`);
                    if (response.ok) {
                        const svg = await response.text();
                        placeholder.innerHTML = svg;
                    } else {
                        placeholder.innerHTML = '<div class="plantuml-error">Failed to render diagram</div>';
                    }
                } catch (error) {
                    console.error('PlantUML render error:', error);
                    placeholder.innerHTML = '<div class="plantuml-error">Failed to render diagram</div>';
                }
            }
        }

        // Render Mermaid diagrams using mermaid.render() (matches VS Code extension)
        async function renderMermaidDiagrams() {
            const codeBlocks = document.querySelectorAll('pre code.language-mermaid');
            console.log(`Found ${codeBlocks.length} mermaid code blocks`);

            if (codeBlocks.length === 0) return;

            // Initialize mermaid with VS Code-compatible settings and custom styling
            mermaid.initialize({
                startOnLoad: false,
                maxTextSize: 50000,
                theme: 'default',
                securityLevel: 'loose',
                themeVariables: {
                    // Text and fonts
                    fontSize: '16px',
                    fontFamily: 'Segoe UI, sans-serif',
                    // Primary colors for boxes
                    primaryColor: '#f0f6fc',
                    primaryTextColor: '#1f2937',
                    primaryBorderColor: '#1f2937',
                    // Lines and connectors
                    lineColor: '#57606a',
                    // Secondary boxes
                    secondBkgColor: '#ffffff',
                    secondTextColor: '#1f2937',
                    secondBorderColor: '#1f2937',
                    // Tertiary
                    tertiaryColor: '#fef3c7',
                    tertiaryTextColor: '#1f2937',
                    tertiaryBorderColor: '#1f2937'
                }
            });

            // Process each diagram
            for (const block of codeBlocks) {
                const source = block.textContent;
                const pre = block.parentElement;

                // Create container for the rendered SVG
                const container = document.createElement('div');
                container.className = 'mermaid';
                container.id = `mermaid-${Math.random().toString(36).substr(2, 9)}`;

                pre.parentNode.replaceChild(container, pre);

                try {
                    // Parse the diagram source for validation
                    await mermaid.parse(source);

                    // Render using mermaid.render() like VS Code does
                    const renderResult = await mermaid.render(container.id, source);
                    container.innerHTML = renderResult.svg;

                    // Call bind functions if they exist
                    if (renderResult.bindFunctions) {
                        renderResult.bindFunctions(container);
                    }

                    console.log('Mermaid diagram rendered successfully');
                } catch (error) {
                    console.error('Mermaid render error:', error);
                    container.innerHTML = `<div class="mermaid-error">Error rendering diagram: ${error.message}</div>`;
                }
            }
        }

        // Apply syntax highlighting to code blocks (lazy-loads highlight.js if needed)
        async function highlightCodeBlocks() {
            const codeBlocks = document.querySelectorAll('pre code');

            // Skip if no code blocks found
            if (codeBlocks.length === 0) return;

            // Lazy-load highlight.js if not already loaded
            try {
                await loadHighlightJs();
            } catch (error) {
                console.error('Failed to load highlight.js:', error);
                return; // Code blocks will just show without highlighting
            }

            codeBlocks.forEach((block) => {
                // Apply syntax highlighting (auto-detects language or uses fence-specified)
                hljs.highlightElement(block);

                // Wrap pre element for copy button positioning
                const pre = block.parentElement;
                if (!pre.parentElement.classList.contains('code-block-wrapper')) {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'code-block-wrapper';
                    pre.parentNode.insertBefore(wrapper, pre);
                    wrapper.appendChild(pre);

                    // Add copy button
                    const copyBtn = document.createElement('button');
                    copyBtn.className = 'copy-button';
                    copyBtn.textContent = 'Copy';
                    copyBtn.addEventListener('click', async () => {
                        try {
                            await navigator.clipboard.writeText(block.textContent);
                            copyBtn.textContent = 'Copied!';
                            copyBtn.classList.add('copied');
                            setTimeout(() => {
                                copyBtn.textContent = 'Copy';
                                copyBtn.classList.remove('copied');
                            }, 2000);
                        } catch (err) {
                            console.error('Failed to copy:', err);
                        }
                    });
                    wrapper.appendChild(copyBtn);
                }
            });
        }

        // Generate a unique ID for a section based on its title
        function generateSectionId(title, index) {
            const slug = title.toLowerCase()
                .replace(/[^a-z0-9]+/g, '-')
                .replace(/^-|-$/g, '');
            return `section-${index}-${slug || 'section'}`;
        }

        // Render large file mode with TOC and accordion sections
        async function renderLargeFileMode(data, contentEl) {
            const { sections, file_dir } = data;

            // Configure marked for GFM
            marked.setOptions({ gfm: true, breaks: true });
            marked.use({ renderer: createImageRenderer(file_dir) });

            // Create banner
            const banner = document.createElement('div');
            banner.className = 'large-file-banner';
            banner.innerHTML = 'Large file mode: Sections are collapsed by default. Use <code>--no-truncate</code> or set <code>no_truncate = true</code> in config to render the entire file.';

            // Create TOC
            const toc = document.createElement('nav');
            toc.className = 'large-file-toc';
            toc.innerHTML = '<h2>Table of Contents</h2>';
            const tocList = document.createElement('ul');

            // Create section containers
            const sectionsContainer = document.createElement('div');
            sectionsContainer.className = 'sections-container';

            for (let i = 0; i < sections.length; i++) {
                const section = sections[i];
                const sectionId = generateSectionId(section.title, i);

                // Add to TOC
                const tocItem = document.createElement('li');
                tocItem.className = `toc-level-${section.level}`;
                const tocLink = document.createElement('a');
                tocLink.href = `#${sectionId}`;
                tocLink.textContent = section.title || 'Untitled Section';
                tocLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    const targetAccordion = document.getElementById(sectionId);
                    if (targetAccordion) {
                        targetAccordion.open = true;
                        targetAccordion.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                });
                tocItem.appendChild(tocLink);
                tocList.appendChild(tocItem);

                // Create accordion section
                const accordion = document.createElement('details');
                accordion.className = 'section-accordion';
                accordion.id = sectionId;

                const summary = document.createElement('summary');
                if (section.level > 0) {
                    const levelBadge = document.createElement('span');
                    levelBadge.className = `section-level section-level-${section.level}`;
                    levelBadge.textContent = `H${section.level}`;
                    summary.appendChild(levelBadge);
                } else {
                    const levelBadge = document.createElement('span');
                    levelBadge.className = 'section-level section-level-0';
                    levelBadge.textContent = 'Intro';
                    summary.appendChild(levelBadge);
                }
                const titleSpan = document.createElement('span');
                titleSpan.textContent = section.title || 'Untitled Section';
                summary.appendChild(titleSpan);

                const contentDiv = document.createElement('div');
                contentDiv.className = 'section-content markdown-body';
                // Sanitize HTML to prevent XSS
                contentDiv.innerHTML = DOMPurify.sanitize(marked.parse(section.content), {
                    USE_PROFILES: { html: true },
                    ADD_ATTR: ['onerror', 'data-original-src', 'class'],
                    FORBID_TAGS: ['script', 'style', 'iframe', 'object', 'embed', 'form'],
                    FORBID_ATTR: ['onclick', 'onload', 'onmouseover', 'onfocus', 'onblur']
                });

                accordion.appendChild(summary);
                accordion.appendChild(contentDiv);
                sectionsContainer.appendChild(accordion);
            }

            toc.appendChild(tocList);

            // Assemble the page
            contentEl.innerHTML = '';
            contentEl.appendChild(banner);
            contentEl.appendChild(toc);
            contentEl.appendChild(sectionsContainer);

            // Apply syntax highlighting
            highlightCodeBlocks();

            // Render PlantUML diagrams if extension is enabled
            if (data.extensions && data.extensions.plantuml) {
                renderPlantUMLDiagrams();
            }

            // Render Mermaid diagrams
            renderMermaidDiagrams();
        }

        async function loadContent() {
            const contentEl = document.getElementById('content');

            try {
                // Get markdown content from Rust backend (Tauri v1 API)
                const { invoke } = window.__TAURI__.tauri;
                const data = await invoke('get_markdown_content');

                // Check if no file is loaded (empty content)
                if (!data.content || data.content.trim() === '') {
                    contentEl.innerHTML = `
                        <div class="welcome">
                            <h1>Glance</h1>
                            <p>A minimal markdown viewer</p>
                            <div class="instructions">
                                <p>Open a markdown file to get started:</p>
                                <ul>
                                    <li>Drag and drop a <code>.md</code> file here</li>
                                    <li>Press <kbd>Cmd+O</kbd> (macOS) or <kbd>Ctrl+O</kbd> (Windows/Linux) to open a file</li>
                                    <li>Double-click a <code>.md</code> file in Finder/Explorer (if set as default app)</li>
                                </ul>
                            </div>
                        </div>
                    `;
                    return true;
                }

                // Check if this is a PlantUML file
                if (data.is_plantuml_file) {
                    await renderPlantUMLFile(data.content, contentEl);
                    return true;
                }

                // Check if we're in large file mode
                if (data.is_large_file && data.sections && data.sections.length > 0) {
                    await renderLargeFileMode(data, contentEl);
                    return true;
                }

                // Normal mode: render full content
                // Configure marked for GFM (GitHub Flavored Markdown)
                marked.setOptions({
                    gfm: true,
                    breaks: true
                });

                // Use custom image renderer to handle local paths and error fallbacks
                marked.use({ renderer: createImageRenderer(data.file_dir) });

                // Render markdown to HTML with XSS sanitization
                const html = marked.parse(data.content);
                contentEl.innerHTML = DOMPurify.sanitize(html, {
                    USE_PROFILES: { html: true },
                    ADD_ATTR: ['onerror', 'data-original-src', 'class'], // Allow class for code highlighting and mermaid
                    FORBID_TAGS: ['script', 'style', 'iframe', 'object', 'embed', 'form'],
                    FORBID_ATTR: ['onclick', 'onload', 'onmouseover', 'onfocus', 'onblur']
                });

                // Apply syntax highlighting to code blocks
                highlightCodeBlocks();

                // Render PlantUML diagrams if extension is enabled
                if (data.extensions && data.extensions.plantuml) {
                    renderPlantUMLDiagrams();
                }

                // Render Mermaid diagrams
                renderMermaidDiagrams();

                return true;
            } catch (error) {
                console.error('Failed to load markdown:', error);
                contentEl.innerHTML = '<div class="error">Failed to load markdown content</div>';
                return false;
            }
        }

        async function reloadWithScrollPreserve() {
            // Save current scroll position
            const scrollX = window.scrollX;
            const scrollY = window.scrollY;

            // Reload content
            const success = await loadContent();

            if (success) {
                // Restore scroll position after content is rendered
                requestAnimationFrame(() => {
                    window.scrollTo(scrollX, scrollY);
                });
            }
        }

        async function openFileDialog() {
            const { open } = window.__TAURI__.dialog;
            const { invoke } = window.__TAURI__.tauri;

            try {
                const selected = await open({
                    filters: [{
                        name: 'Markdown',
                        extensions: ['md', 'markdown']
                    }],
                    multiple: false
                });

                if (selected && typeof selected === 'string') {
                    await invoke('open_dropped_file', { path: selected });
                    await loadContent();
                }
            } catch (error) {
                console.error('Failed to open file:', error);
            }
        }

        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                // Cmd+O (Mac) or Ctrl+O (Windows/Linux) to open file
                if ((e.metaKey || e.ctrlKey) && e.key === 'o') {
                    e.preventDefault();
                    openFileDialog();
                }

                // Zoom shortcuts - Cmd/Ctrl + Plus/Minus/0
                if (e.metaKey || e.ctrlKey) {
                    // Zoom in: Cmd/Ctrl + Plus or Cmd/Ctrl + = (for keyboards without numpad)
                    if (e.key === '+' || e.key === '=') {
                        e.preventDefault();
                        zoomIn();
                    }
                    // Zoom out: Cmd/Ctrl + Minus
                    else if (e.key === '-') {
                        e.preventDefault();
                        zoomOut();
                    }
                    // Reset zoom: Cmd/Ctrl + 0
                    else if (e.key === '0') {
                        e.preventDefault();
                        resetZoom();
                    }
                }
            });
        }

        function setupDragAndDrop() {
            const { invoke } = window.__TAURI__.tauri;

            // Prevent default drag behaviors
            document.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.stopPropagation();
            });

            document.addEventListener('dragenter', (e) => {
                e.preventDefault();
                e.stopPropagation();
            });

            document.addEventListener('dragleave', (e) => {
                e.preventDefault();
                e.stopPropagation();
            });

            document.addEventListener('drop', async (e) => {
                e.preventDefault();
                e.stopPropagation();

                const files = e.dataTransfer?.files;
                if (!files || files.length === 0) return;

                // Get the first file
                const file = files[0];

                // Check if it's a markdown file by name
                const name = file.name.toLowerCase();
                if (!name.endsWith('.md') && !name.endsWith('.markdown')) {
                    console.error('Only markdown files are supported');
                    return;
                }

                // Get the file path - we need to use the path property which is available for dropped files
                const path = file.path;
                if (!path) {
                    console.error('Could not get file path');
                    return;
                }

                try {
                    await invoke('open_dropped_file', { path });
                    // Reload content after successful file open
                    await loadContent();
                } catch (error) {
                    console.error('Failed to open dropped file:', error);
                }
            });
        }

        async function init() {
            // Performance timing
            const startTime = performance.now();

            // Initial load
            await loadContent();

            const endTime = performance.now();
            console.log(`âš¡ Content rendered in ${(endTime - startTime).toFixed(2)}ms`);

            // Apply saved zoom level from session
            if (currentZoom !== ZOOM_DEFAULT) {
                applyZoom();
            }

            // Set up drag and drop
            setupDragAndDrop();

            // Set up keyboard shortcuts (Cmd+O to open file, zoom controls)
            setupKeyboardShortcuts();

            // Listen for file change events from backend
            const { listen } = window.__TAURI__.event;
            await listen('file-changed', () => {
                reloadWithScrollPreserve();
            });

            // Listen for file loaded events (daemon mode - new file via socket)
            await listen('file-loaded', () => {
                reloadWithScrollPreserve();
            });

            // Re-render when color scheme changes
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
                reloadWithScrollPreserve();
            });
        }

        // Initialize when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>
