<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Glance</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@5/github-markdown-light.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11/styles/github.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked@12/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11/lib/core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11/lib/common.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans', Helvetica, Arial, sans-serif;
        }

        body {
            background-color: #ffffff;
        }

        .markdown-body {
            padding: 32px;
            max-width: 980px;
            margin: 0 auto;
            min-height: 100%;
        }

        .error {
            color: #cf222e;
            padding: 20px;
            text-align: center;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            color: #656d76;
        }

        /* Code block container for copy button */
        .code-block-wrapper {
            position: relative;
        }

        .code-block-wrapper .copy-button {
            position: absolute;
            top: 8px;
            right: 8px;
            padding: 4px 8px;
            font-size: 12px;
            color: #57606a;
            background-color: #f6f8fa;
            border: 1px solid #d0d7de;
            border-radius: 6px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.15s ease-in-out;
        }

        .code-block-wrapper:hover .copy-button {
            opacity: 1;
        }

        .code-block-wrapper .copy-button:hover {
            background-color: #f3f4f6;
            border-color: #c5cbd1;
        }

        .code-block-wrapper .copy-button:active {
            background-color: #ebecef;
        }

        .code-block-wrapper .copy-button.copied {
            color: #1a7f37;
            border-color: #1a7f37;
        }
    </style>
</head>
<body>
    <article id="content" class="markdown-body">
        <div class="loading">Loading...</div>
    </article>

    <script>
        // Apply syntax highlighting and copy buttons to code blocks
        function highlightCodeBlocks() {
            const codeBlocks = document.querySelectorAll('pre code');
            codeBlocks.forEach((block) => {
                // Apply syntax highlighting (auto-detects language or uses fence-specified)
                hljs.highlightElement(block);

                // Wrap pre element for copy button positioning
                const pre = block.parentElement;
                if (!pre.parentElement.classList.contains('code-block-wrapper')) {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'code-block-wrapper';
                    pre.parentNode.insertBefore(wrapper, pre);
                    wrapper.appendChild(pre);

                    // Add copy button
                    const copyBtn = document.createElement('button');
                    copyBtn.className = 'copy-button';
                    copyBtn.textContent = 'Copy';
                    copyBtn.addEventListener('click', async () => {
                        try {
                            await navigator.clipboard.writeText(block.textContent);
                            copyBtn.textContent = 'Copied!';
                            copyBtn.classList.add('copied');
                            setTimeout(() => {
                                copyBtn.textContent = 'Copy';
                                copyBtn.classList.remove('copied');
                            }, 2000);
                        } catch (err) {
                            console.error('Failed to copy:', err);
                        }
                    });
                    wrapper.appendChild(copyBtn);
                }
            });
        }

        async function loadContent() {
            const contentEl = document.getElementById('content');

            try {
                // Get markdown content from Rust backend (Tauri v1 API)
                const { invoke } = window.__TAURI__.tauri;
                const data = await invoke('get_markdown_content');

                // Configure marked for GFM (GitHub Flavored Markdown)
                marked.setOptions({
                    gfm: true,
                    breaks: true
                });

                // Render markdown to HTML
                const html = marked.parse(data.content);
                contentEl.innerHTML = html;

                // Apply syntax highlighting to code blocks
                highlightCodeBlocks();

                return true;
            } catch (error) {
                console.error('Failed to load markdown:', error);
                contentEl.innerHTML = '<div class="error">Failed to load markdown content</div>';
                return false;
            }
        }

        async function reloadWithScrollPreserve() {
            // Save current scroll position
            const scrollX = window.scrollX;
            const scrollY = window.scrollY;

            // Reload content
            const success = await loadContent();

            if (success) {
                // Restore scroll position after content is rendered
                requestAnimationFrame(() => {
                    window.scrollTo(scrollX, scrollY);
                });
            }
        }

        async function init() {
            // Initial load
            await loadContent();

            // Listen for file change events from backend
            const { listen } = window.__TAURI__.event;
            await listen('file-changed', () => {
                reloadWithScrollPreserve();
            });
        }

        // Initialize when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>
