<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Glance</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@5/github-markdown.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11/styles/github.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11/styles/github-dark.min.css" media="(prefers-color-scheme: dark)">
    <script src="https://cdn.jsdelivr.net/npm/marked@12/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11/lib/core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11/lib/common.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans', Helvetica, Arial, sans-serif;
        }

        body {
            background-color: #ffffff;
        }

        .markdown-body {
            padding: 32px;
            max-width: 980px;
            margin: 0 auto;
            min-height: 100%;
        }

        .error {
            color: #cf222e;
            padding: 20px;
            text-align: center;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            color: #656d76;
        }

        /* Code block container for copy button */
        .code-block-wrapper {
            position: relative;
        }

        .code-block-wrapper .copy-button {
            position: absolute;
            top: 8px;
            right: 8px;
            padding: 4px 8px;
            font-size: 12px;
            color: #57606a;
            background-color: #f6f8fa;
            border: 1px solid #d0d7de;
            border-radius: 6px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.15s ease-in-out;
        }

        .code-block-wrapper:hover .copy-button {
            opacity: 1;
        }

        .code-block-wrapper .copy-button:hover {
            background-color: #f3f4f6;
            border-color: #c5cbd1;
        }

        .code-block-wrapper .copy-button:active {
            background-color: #ebecef;
        }

        .code-block-wrapper .copy-button.copied {
            color: #1a7f37;
            border-color: #1a7f37;
        }

        /* Mermaid diagram container */
        .mermaid-container {
            margin: 16px 0;
            text-align: center;
        }

        .mermaid-container svg {
            max-width: 100%;
            height: auto;
        }

        /* Mermaid error styling */
        .mermaid-error {
            background-color: #fff8f8;
            border: 1px solid #f5c6cb;
            border-radius: 6px;
            padding: 16px;
            margin: 16px 0;
            color: #721c24;
            font-family: monospace;
            font-size: 14px;
            text-align: left;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .mermaid-error-title {
            font-weight: 600;
            margin-bottom: 8px;
            display: block;
        }

        /* Image error placeholder */
        .image-placeholder {
            background-color: #f6f8fa;
            border: 2px dashed #d0d7de;
            border-radius: 8px;
            padding: 16px;
            text-align: center;
            margin: 16px 0;
            display: inline-block;
            min-width: 200px;
        }

        .image-error {
            color: #57606a;
        }

        .image-error-icon {
            font-size: 32px;
            margin-bottom: 8px;
        }

        .image-error-text {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .image-error-alt {
            font-size: 12px;
            font-family: monospace;
            margin-top: 4px;
            word-break: break-word;
        }

        .image-error-src {
            font-size: 11px;
            font-family: monospace;
            color: #8b949e;
            margin-top: 4px;
            word-break: break-all;
            max-width: 300px;
        }

        /* Dark mode support */
        @media (prefers-color-scheme: dark) {
            body {
                background-color: #0d1117;
            }

            .markdown-body {
                color-scheme: dark;
                --color-canvas-default: #0d1117;
                --color-canvas-subtle: #161b22;
                --color-border-default: #30363d;
                --color-border-muted: #21262d;
            }

            .code-block-wrapper .copy-button {
                color: #8b949e;
                background-color: #21262d;
                border-color: #30363d;
            }

            .code-block-wrapper:hover .copy-button {
                background-color: #30363d;
            }

            .code-block-wrapper .copy-button:hover {
                background-color: #30363d;
                border-color: #484f58;
            }

            .code-block-wrapper .copy-button.copied {
                color: #3fb950;
                border-color: #3fb950;
            }

            .mermaid-error {
                background-color: #2d1f1f;
                border-color: #6e3030;
                color: #f85149;
            }

            .image-placeholder {
                background-color: #161b22;
                border-color: #30363d;
            }

            .image-error {
                color: #8b949e;
            }

            .image-error-src {
                color: #6e7681;
            }
        }

        /* Zoom indicator */
        #zoom-indicator {
            position: fixed;
            bottom: 16px;
            right: 16px;
            padding: 6px 12px;
            font-size: 12px;
            font-weight: 500;
            color: #57606a;
            background-color: rgba(246, 248, 250, 0.95);
            border: 1px solid #d0d7de;
            border-radius: 6px;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            pointer-events: none;
            z-index: 1000;
        }

        #zoom-indicator.visible {
            opacity: 0.6;
        }

        #zoom-indicator.active {
            opacity: 1;
        }

        @media (prefers-color-scheme: dark) {
            #zoom-indicator {
                color: #8b949e;
                background-color: rgba(33, 38, 45, 0.95);
                border-color: #30363d;
            }
        }
    </style>
</head>
<body>
    <article id="content" class="markdown-body">
        <div class="loading">Loading...</div>
    </article>

    <script>
        // Zoom state - persisted in sessionStorage
        const ZOOM_MIN = 50;
        const ZOOM_MAX = 200;
        const ZOOM_STEP = 10;
        const ZOOM_DEFAULT = 100;

        let currentZoom = parseInt(sessionStorage.getItem('zoomLevel')) || ZOOM_DEFAULT;

        function applyZoom() {
            const contentEl = document.getElementById('content');
            contentEl.style.transformOrigin = 'top center';
            contentEl.style.transform = `scale(${currentZoom / 100})`;

            // Adjust body height to accommodate scaled content
            document.body.style.minHeight = `${100 * (currentZoom / 100)}%`;

            // Persist zoom level
            sessionStorage.setItem('zoomLevel', currentZoom);

            // Update zoom indicator
            updateZoomIndicator();
        }

        function zoomIn() {
            if (currentZoom < ZOOM_MAX) {
                currentZoom = Math.min(currentZoom + ZOOM_STEP, ZOOM_MAX);
                applyZoom();
            }
        }

        function zoomOut() {
            if (currentZoom > ZOOM_MIN) {
                currentZoom = Math.max(currentZoom - ZOOM_STEP, ZOOM_MIN);
                applyZoom();
            }
        }

        function resetZoom() {
            currentZoom = ZOOM_DEFAULT;
            applyZoom();
        }

        function updateZoomIndicator() {
            let indicator = document.getElementById('zoom-indicator');
            if (!indicator) {
                indicator = document.createElement('div');
                indicator.id = 'zoom-indicator';
                document.body.appendChild(indicator);
            }

            // Only show indicator when zoom is not at default
            if (currentZoom !== ZOOM_DEFAULT) {
                indicator.textContent = `${currentZoom}%`;
                indicator.classList.add('visible');
            } else {
                indicator.classList.remove('visible');
            }

            // Briefly show indicator on any zoom change, then fade
            indicator.classList.add('active');
            clearTimeout(indicator.fadeTimeout);
            indicator.fadeTimeout = setTimeout(() => {
                indicator.classList.remove('active');
            }, 1500);
        }

        // Initialize Mermaid with theme based on system preference
        function initMermaid() {
            const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            mermaid.initialize({
                startOnLoad: false,
                theme: isDark ? 'dark' : 'default',
                securityLevel: 'strict'
            });
        }

        // Render Mermaid diagrams from code blocks
        async function renderMermaidDiagrams() {
            const codeBlocks = document.querySelectorAll('pre code.language-mermaid');

            for (const block of codeBlocks) {
                const pre = block.parentElement;
                const code = block.textContent;
                const container = document.createElement('div');
                container.className = 'mermaid-container';

                try {
                    // Generate unique ID for each diagram
                    const id = 'mermaid-' + Math.random().toString(36).substr(2, 9);
                    const { svg } = await mermaid.render(id, code);
                    container.innerHTML = svg;
                } catch (error) {
                    // Show inline error message for failed diagrams
                    container.className = 'mermaid-error';
                    container.innerHTML = '<span class="mermaid-error-title">Mermaid Diagram Error</span>' +
                        escapeHtml(error.message || String(error));
                }

                pre.parentNode.replaceChild(container, pre);
            }
        }

        // Helper to escape HTML for error messages
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Truncate URL for display
        function truncateUrl(url, maxLength) {
            if (url.length <= maxLength) return url;
            return url.substring(0, maxLength - 3) + '...';
        }

        // Handle image load errors - show placeholder with alt text
        function handleImageError(img) {
            const alt = img.alt || 'Image';
            const src = img.getAttribute('data-original-src') || img.src;

            const placeholder = document.createElement('div');
            placeholder.className = 'image-placeholder';
            placeholder.innerHTML = `
                <div class="image-error">
                    <div class="image-error-icon">&#128444;</div>
                    <div class="image-error-text">Image failed to load</div>
                    <div class="image-error-alt">${escapeHtml(alt)}</div>
                    <div class="image-error-src" title="${escapeHtml(src)}">${escapeHtml(truncateUrl(src, 50))}</div>
                </div>
            `;

            img.parentNode.replaceChild(placeholder, img);
        }

        // Resolve relative path against base directory
        function resolveRelativePath(baseDir, relativePath) {
            // Handle absolute paths (starts with /)
            if (relativePath.startsWith('/')) {
                return relativePath;
            }

            const baseParts = baseDir.split('/').filter(p => p !== '');
            const pathParts = relativePath.split('/');

            for (const part of pathParts) {
                if (part === '..') {
                    baseParts.pop();
                } else if (part !== '.' && part !== '') {
                    baseParts.push(part);
                }
            }

            return '/' + baseParts.join('/');
        }

        // Create custom image renderer for marked
        function createImageRenderer(fileDir) {
            return {
                image(token) {
                    let src = token.href;
                    const alt = escapeHtml(token.text || '');
                    const title = token.title ? ` title="${escapeHtml(token.title)}"` : '';

                    // Keep track of original src for error display
                    const originalSrc = src;

                    // Check if it's a data URL (base64) or remote URL
                    const isDataUrl = src.startsWith('data:');
                    const isRemoteUrl = src.startsWith('http://') || src.startsWith('https://');

                    // Resolve local relative paths
                    if (!isDataUrl && !isRemoteUrl && fileDir) {
                        const resolvedPath = resolveRelativePath(fileDir, src);
                        // Use Tauri's convertFileSrc for local files
                        src = window.__TAURI__.tauri.convertFileSrc(resolvedPath);
                    }

                    return `<img src="${src}" alt="${alt}"${title} data-original-src="${escapeHtml(originalSrc)}" onerror="handleImageError(this)" style="max-width:100%;height:auto;">`;
                }
            };
        }

        // Apply syntax highlighting and copy buttons to code blocks
        function highlightCodeBlocks() {
            const codeBlocks = document.querySelectorAll('pre code');
            codeBlocks.forEach((block) => {
                // Apply syntax highlighting (auto-detects language or uses fence-specified)
                hljs.highlightElement(block);

                // Wrap pre element for copy button positioning
                const pre = block.parentElement;
                if (!pre.parentElement.classList.contains('code-block-wrapper')) {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'code-block-wrapper';
                    pre.parentNode.insertBefore(wrapper, pre);
                    wrapper.appendChild(pre);

                    // Add copy button
                    const copyBtn = document.createElement('button');
                    copyBtn.className = 'copy-button';
                    copyBtn.textContent = 'Copy';
                    copyBtn.addEventListener('click', async () => {
                        try {
                            await navigator.clipboard.writeText(block.textContent);
                            copyBtn.textContent = 'Copied!';
                            copyBtn.classList.add('copied');
                            setTimeout(() => {
                                copyBtn.textContent = 'Copy';
                                copyBtn.classList.remove('copied');
                            }, 2000);
                        } catch (err) {
                            console.error('Failed to copy:', err);
                        }
                    });
                    wrapper.appendChild(copyBtn);
                }
            });
        }

        async function loadContent() {
            const contentEl = document.getElementById('content');

            try {
                // Get markdown content from Rust backend (Tauri v1 API)
                const { invoke } = window.__TAURI__.tauri;
                const data = await invoke('get_markdown_content');

                // Configure marked for GFM (GitHub Flavored Markdown)
                marked.setOptions({
                    gfm: true,
                    breaks: true
                });

                // Use custom image renderer to handle local paths and error fallbacks
                marked.use({ renderer: createImageRenderer(data.file_dir) });

                // Render markdown to HTML
                const html = marked.parse(data.content);
                contentEl.innerHTML = html;

                // Render Mermaid diagrams first (before highlighting removes them)
                await renderMermaidDiagrams();

                // Apply syntax highlighting to remaining code blocks
                highlightCodeBlocks();

                return true;
            } catch (error) {
                console.error('Failed to load markdown:', error);
                contentEl.innerHTML = '<div class="error">Failed to load markdown content</div>';
                return false;
            }
        }

        async function reloadWithScrollPreserve() {
            // Save current scroll position
            const scrollX = window.scrollX;
            const scrollY = window.scrollY;

            // Reload content
            const success = await loadContent();

            if (success) {
                // Restore scroll position after content is rendered
                requestAnimationFrame(() => {
                    window.scrollTo(scrollX, scrollY);
                });
            }
        }

        async function openFileDialog() {
            const { open } = window.__TAURI__.dialog;
            const { invoke } = window.__TAURI__.tauri;

            try {
                const selected = await open({
                    filters: [{
                        name: 'Markdown',
                        extensions: ['md', 'markdown']
                    }],
                    multiple: false
                });

                if (selected && typeof selected === 'string') {
                    await invoke('open_dropped_file', { path: selected });
                    await loadContent();
                }
            } catch (error) {
                console.error('Failed to open file:', error);
            }
        }

        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                // Cmd+O (Mac) or Ctrl+O (Windows/Linux) to open file
                if ((e.metaKey || e.ctrlKey) && e.key === 'o') {
                    e.preventDefault();
                    openFileDialog();
                }

                // Zoom shortcuts - Cmd/Ctrl + Plus/Minus/0
                if (e.metaKey || e.ctrlKey) {
                    // Zoom in: Cmd/Ctrl + Plus or Cmd/Ctrl + = (for keyboards without numpad)
                    if (e.key === '+' || e.key === '=') {
                        e.preventDefault();
                        zoomIn();
                    }
                    // Zoom out: Cmd/Ctrl + Minus
                    else if (e.key === '-') {
                        e.preventDefault();
                        zoomOut();
                    }
                    // Reset zoom: Cmd/Ctrl + 0
                    else if (e.key === '0') {
                        e.preventDefault();
                        resetZoom();
                    }
                }
            });
        }

        function setupDragAndDrop() {
            const { invoke } = window.__TAURI__.tauri;

            // Prevent default drag behaviors
            document.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.stopPropagation();
            });

            document.addEventListener('dragenter', (e) => {
                e.preventDefault();
                e.stopPropagation();
            });

            document.addEventListener('dragleave', (e) => {
                e.preventDefault();
                e.stopPropagation();
            });

            document.addEventListener('drop', async (e) => {
                e.preventDefault();
                e.stopPropagation();

                const files = e.dataTransfer?.files;
                if (!files || files.length === 0) return;

                // Get the first file
                const file = files[0];

                // Check if it's a markdown file by name
                const name = file.name.toLowerCase();
                if (!name.endsWith('.md') && !name.endsWith('.markdown')) {
                    console.error('Only markdown files are supported');
                    return;
                }

                // Get the file path - we need to use the path property which is available for dropped files
                const path = file.path;
                if (!path) {
                    console.error('Could not get file path');
                    return;
                }

                try {
                    await invoke('open_dropped_file', { path });
                    // Reload content after successful file open
                    await loadContent();
                } catch (error) {
                    console.error('Failed to open dropped file:', error);
                }
            });
        }

        async function init() {
            // Initialize Mermaid with correct theme
            initMermaid();

            // Initial load
            await loadContent();

            // Apply saved zoom level from session
            if (currentZoom !== ZOOM_DEFAULT) {
                applyZoom();
            }

            // Set up drag and drop
            setupDragAndDrop();

            // Set up keyboard shortcuts (Cmd+O to open file, zoom controls)
            setupKeyboardShortcuts();

            // Listen for file change events from backend
            const { listen } = window.__TAURI__.event;
            await listen('file-changed', () => {
                reloadWithScrollPreserve();
            });

            // Re-render diagrams when color scheme changes
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
                initMermaid();
                reloadWithScrollPreserve();
            });
        }

        // Initialize when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>
