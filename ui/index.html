<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Glance</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@5/github-markdown-light.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked@12/marked.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans', Helvetica, Arial, sans-serif;
        }

        body {
            background-color: #ffffff;
        }

        .markdown-body {
            padding: 32px;
            max-width: 980px;
            margin: 0 auto;
            min-height: 100%;
        }

        .error {
            color: #cf222e;
            padding: 20px;
            text-align: center;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            color: #656d76;
        }
    </style>
</head>
<body>
    <article id="content" class="markdown-body">
        <div class="loading">Loading...</div>
    </article>

    <script>
        async function loadContent() {
            const contentEl = document.getElementById('content');

            try {
                // Get markdown content from Rust backend (Tauri v1 API)
                const { invoke } = window.__TAURI__.tauri;
                const data = await invoke('get_markdown_content');

                // Configure marked for GFM (GitHub Flavored Markdown)
                marked.setOptions({
                    gfm: true,
                    breaks: true
                });

                // Render markdown to HTML
                const html = marked.parse(data.content);
                contentEl.innerHTML = html;

                return true;
            } catch (error) {
                console.error('Failed to load markdown:', error);
                contentEl.innerHTML = '<div class="error">Failed to load markdown content</div>';
                return false;
            }
        }

        async function reloadWithScrollPreserve() {
            // Save current scroll position
            const scrollX = window.scrollX;
            const scrollY = window.scrollY;

            // Reload content
            const success = await loadContent();

            if (success) {
                // Restore scroll position after content is rendered
                requestAnimationFrame(() => {
                    window.scrollTo(scrollX, scrollY);
                });
            }
        }

        async function init() {
            // Initial load
            await loadContent();

            // Listen for file change events from backend
            const { listen } = window.__TAURI__.event;
            await listen('file-changed', () => {
                reloadWithScrollPreserve();
            });
        }

        // Initialize when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>
